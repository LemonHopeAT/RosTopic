# ARCH Messaging System - ROS2-like Topic Implementation

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã —Å–æ–æ–±—â–µ–Ω–∏–π, –≤–¥–æ—Ö–Ω–æ–≤–ª–µ–Ω–Ω–∞—è ROS2 Topic, –Ω–∞–ø–∏—Å–∞–Ω–Ω–∞—è –Ω–∞ C++17 —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º lock-free –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤.

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø—É–±–ª–∏–∫–∞—Ü–∏–∏/–ø–æ–¥–ø–∏—Å–∫–∏ (pub/sub) –¥–ª—è –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –º–µ–∂–¥—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–∞ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç lock-free —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏.

### –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **Lock-free –æ—á–µ—Ä–µ–¥–∏**: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è MPMC (Multi-Producer Multi-Consumer) –∏ SPSC (Single-Producer Single-Consumer) –æ—á–µ—Ä–µ–¥–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ Vyukov
- ‚úÖ **QoS (Quality of Service)**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø–æ–ª–∏—Ç–∏–∫ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∏ –¥–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç–∏
- ‚úÖ **Executor**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ worker-–ø–æ—Ç–æ–∫–∞—Ö
- ‚úÖ **Callback Groups**: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∫–æ–ª–±—ç–∫–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤–∑–∞–∏–º–Ω–æ–≥–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–ª–∏ —Ä–µ–µ–Ω—Ç–µ—Ä–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ **Epoch-based Memory Reclamation**: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é –≤ lock-free —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö
- ‚úÖ **Comprehensive Benchmarking**: –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
Publisher ----> Topic ----> SubscriberSlot (Lock-free Queue) ----> Executor ----> Callback
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

#### ROS2-–ø–æ–¥–æ–±–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (–Ω–æ–≤—ã–µ):
- **`Factory`**: –§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ç–æ—Ä–æ–≤ –∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ (ROS2-like API). –£–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π.
- **`Subscription<T>`**: –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–æ–ø–∏–∫ (ROS2-like API). –û–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ `SubscriberSlot`.
- **`Waitable`**: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã Executor.
- **`Entity`**: –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–µ–π (Publisher, Subscription, Timer, etc.).

#### –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- **`Topic<T>`**: –ö–∞–Ω–∞–ª –¥–ª—è –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ —Ç–∏–ø–∞ `T`. –£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø–∏—Å–∫–æ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.
- **`Publisher<T>`**: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ç–æ–ø–∏–∫.
- **`SubscriberSlot<T>`**: –°–ª–æ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ —Å lock-free –æ—á–µ—Ä–µ–¥—å—é —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∫–æ–ª–±—ç–∫–æ–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.
- **`Executor`**: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –æ—á–µ—Ä–µ–¥–µ–π –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –≤ worker-–ø–æ—Ç–æ–∫–∞—Ö.
- **`CallbackGroup`**: –ì—Ä—É–ø–ø–∞ –∫–æ–ª–±—ç–∫–æ–≤ —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (MutuallyExclusive –∏–ª–∏ Reentrant).
- **`QoS`**: –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è (Reliability, Durability, History Depth).

## üì¶ –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **C++17** –∏–ª–∏ –≤—ã—à–µ
- **CMake 3.14+**
- **Qt5/Qt6 Core** (–¥–ª—è WaitSet)
- **pthread** (Linux)
- **GCC 9+** –∏–ª–∏ **Clang 10+** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

## üî® –°–±–æ—Ä–∫–∞

### Linux

```bash
# –°–æ–∑–¥–∞–π—Ç–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–±–æ—Ä–∫–∏
mkdir build && cd build

# –ù–∞—Å—Ç—Ä–æ–π—Ç–µ CMake
cmake .. -DCMAKE_BUILD_TYPE=Release

# –°–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç
make -j$(nproc)

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≥—Ä–∞–º–º—É
./ROS_TOPIC
```

### –û–ø—Ü–∏–∏ —Å–±–æ—Ä–∫–∏

- **AddressSanitizer**: –í–∫–ª—é—á–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (`USE_ASAN=ON`)
  ```bash
  cmake .. -DUSE_ASAN=OFF  # –û—Ç–∫–ª—é—á–∏—Ç—å ASan
  ```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### ROS2-–ø–æ–¥–æ–±–Ω—ã–π API (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–ù–æ–≤—ã–π API –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–∏–±–ª–∏–∂–µ–Ω –∫ ROS2:

```cpp
#include <arch/communication/impl/factory.h>
#include <arch/communication/impl/executor.h>
#include <arch/communication/impl/qos.h>

using namespace arch::experimental;

// –°–æ–∑–¥–∞–µ–º executor
auto executor = std::make_shared<Executor>(2);
executor->start();

// –°–æ–∑–¥–∞–µ–º factory (ROS2-like API)
auto factory = std::make_shared<Factory>("my_factory");

// –°–æ–∑–¥–∞–µ–º publisher —á–µ—Ä–µ–∑ Factory
auto publisher = factory->createPublisher<std::string>("/chatter", QoS::Reliable(100));

// –°–æ–∑–¥–∞–µ–º subscription —á–µ—Ä–µ–∑ Factory
auto subscription = factory->createSubscription<std::string>(
    "/chatter",
    [](auto msg) {
        std::cout << "Received: " << msg->data << std::endl;
    },
    QoS::Reliable(100)
);

// –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ø–∏–∫–∏ –≤ executor
// Factory –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è subscriptions/publishers
// Executor —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é —Å Topic
auto topic = factory->getTopic<std::string>("/chatter");
if (topic)
{
    executor->add_topic(topic);
}

// –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
publisher->publish("Hello, World!");

// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
executor->spin_once(std::chrono::milliseconds(100));

// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
executor->stop();
factory->destroy();
```

### –ë–∞–∑–æ–≤—ã–π API (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)

```cpp
#include <arch/communication/impl/topic.h>
#include <arch/communication/impl/publisher.h>
#include <arch/communication/impl/executor.h>
#include <arch/communication/impl/callback_group.h>
#include <arch/communication/impl/qos.h>

using namespace arch::experimental;

// –°–æ–∑–¥–∞–µ–º —Ç–æ–ø–∏–∫ –¥–ª—è —Å—Ç—Ä–æ–∫–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
auto topic = std::make_shared<Topic<std::string>>(
    "/my_topic", 
    QoS::Reliable(1000)  // –ù–∞–¥–µ–∂–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞, –≥–ª—É–±–∏–Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏ 1000
);

// –°–æ–∑–¥–∞–µ–º executor –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
auto executor = std::make_shared<Executor>(2);  // 2 worker-–ø–æ—Ç–æ–∫–∞
executor->add_topic(topic);
executor->start();

// –°–æ–∑–¥–∞–µ–º –≥—Ä—É–ø–ø—É –∫–æ–ª–±—ç–∫–æ–≤
auto callback_group = std::make_shared<CallbackGroup>(
    CallbackGroup::Type::Reentrant,
    "my_group"
);

// –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Ç–æ–ø–∏–∫
auto slot = topic->subscribe(
    [](auto msg) {
        std::cout << "Received: " << msg->data << std::endl;
    },
    callback_group,
    QoS::Reliable(1000)
);

// –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
Publisher<std::string> publisher(topic);
publisher.publish("Hello, World!");

// –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É
std::this_thread::sleep_for(std::chrono::milliseconds(100));

// –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º executor
executor->stop();
topic->destroy();
```

### –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø—Ä–∏–º–µ—Ä —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏

```cpp
// –°–æ–∑–¥–∞–µ–º —Ç–æ–ø–∏–∫
auto topic = std::make_shared<Topic<int>>("/numbers", QoS::Reliable(1000));

// –°–æ–∑–¥–∞–µ–º executor
auto executor = std::make_shared<Executor>(4);  // 4 worker-–ø–æ—Ç–æ–∫–∞
executor->add_topic(topic);

// –°–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
for (int i = 0; i < 3; ++i) {
    auto group = std::make_shared<CallbackGroup>(
        CallbackGroup::Type::Reentrant,
        "group_" + std::to_string(i)
    );
    
    topic->subscribe(
        [i](auto msg) {
            std::cout << "Subscriber " << i 
                      << " received: " << msg->data << std::endl;
        },
        group,
        QoS::Reliable(1000)
    );
}

executor->start();

// –ü—É–±–ª–∏–∫—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
Publisher<int> publisher(topic);
for (int i = 0; i < 10; ++i) {
    publisher.publish(i);
}

// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
executor->spin_once(std::chrono::seconds(1));

executor->stop();
topic->destroy();
```

## üìä –ë–µ–Ω—á–º–∞—Ä–∫–∏

–°–∏—Å—Ç–µ–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –±–µ–Ω—á–º–∞—Ä–∫–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

### –ó–∞–ø—É—Å–∫ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤

```cpp
#include <arch/experimental/benchmark.h>

using namespace arch::experimental;

// –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ —Å —É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
auto results = Benchmark::run_all_benchmarks(3);  // 3 –∏—Ç–µ—Ä–∞—Ü–∏–∏ –Ω–∞ —Ç–µ—Å—Ç

// –í—ã–≤–æ–¥ —Å–≤–æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã
Benchmark::print_summary_table(results);

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ CSV
Benchmark::save_results_to_csv(results, "results.csv");
```

### –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ—Å—Ç—ã

1. **Single Producer - Single Consumer (SPSC)**: –¢–µ—Å—Ç –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–¥—é—Å–µ—Ä–∞ –∏ –æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Å—å—é–º–µ—Ä–∞
2. **Multiple Producers - Single Consumer (MPSC)**: –¢–µ—Å—Ç —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø—Ä–æ–¥—é—Å–µ—Ä–∞–º–∏ –∏ –æ–¥–Ω–∏–º –∫–æ–Ω—Å—å—é–º–µ—Ä–æ–º
3. **Latency Test**: –ò–∑–º–µ—Ä–µ–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
4. **Memory Usage Test**: –û—Ü–µ–Ω–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏

### –ú–µ—Ç—Ä–∏–∫–∏ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤

- **Throughput**: –°–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É
- **Latency**: –°—Ä–µ–¥–Ω—è—è, –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª–∏ (P50, P95, P99, P99.9)
- **Memory Usage**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- **Efficiency**: –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **Queue Metrics**: –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏, –ø–∏–∫–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞

## ‚öôÔ∏è QoS (Quality of Service)

### Reliability (–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å)

- **`Reliable`**: –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –¥–æ—Å—Ç–∞–≤–∫—É –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏)
- **`BestEffort`**: –î–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è "–∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—Å—è" (–º–æ–∂–µ—Ç —Ç–µ—Ä—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è)

### Durability (–î–æ–ª–≥–æ–≤–µ—á–Ω–æ—Å—Ç—å)

- **`Volatile`**: –°–æ–æ–±—â–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
- **`TransientLocal`**: –ü–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤

### History Depth

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.

### –ü—Ä–∏–º–µ—Ä—ã QoS

```cpp
// –ù–∞–¥–µ–∂–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞ —Å –≥–ª—É–±–∏–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ 1000
QoS::Reliable(1000)

// Best-effort –¥–æ—Å—Ç–∞–≤–∫–∞
QoS::BestEffort(100)

// TransientLocal —Å –≥–ª—É–±–∏–Ω–æ–π 500
QoS::TransientLocal(500)
```

## üîß Callback Groups

Callback Groups –ø–æ–∑–≤–æ–ª—è—é—Ç –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–ª–±—ç–∫–æ–≤:

- **`MutuallyExclusive`**: –ö–æ–ª–±—ç–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (–≤–∑–∞–∏–º–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ)
- **`Reentrant`**: –ö–æ–ª–±—ç–∫–∏ –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (—Ä–µ–µ–Ω—Ç–µ—Ä–∞–±–µ–ª—å–Ω—ã–µ)

```cpp
// –í–∑–∞–∏–º–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ - –∫–æ–ª–±—ç–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ –æ–¥–Ω–æ–º—É
auto mutex_group = std::make_shared<CallbackGroup>(
    CallbackGroup::Type::MutuallyExclusive,
    "mutex_group"
);

// –†–µ–µ–Ω—Ç–µ—Ä–∞–±–µ–ª—å–Ω—ã–µ - –∫–æ–ª–±—ç–∫–∏ –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
auto reentrant_group = std::make_shared<CallbackGroup>(
    CallbackGroup::Type::Reentrant,
    "reentrant_group"
);
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ –¥–µ–º–æ-–ø—Ä–∏–º–µ—Ä–æ–≤

–í `main.cpp` –¥–æ—Å—Ç—É–ø–Ω—ã —Ä–∞–∑–ª–∏—á–Ω—ã–µ –¥–µ–º–æ-–ø—Ä–∏–º–µ—Ä—ã:

```cpp
#define TEST_0  // –ë–∞–∑–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä
#define TEST_1  // –ü—Ä–∏–º–µ—Ä —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º–∏
#define TEST_2  // –ü—Ä–∏–º–µ—Ä —Å QoS
#define TEST_3  // –ü—Ä–∏–º–µ—Ä —Å CallbackGroup
#define TEST_BECH  // –ó–∞–ø—É—Å–∫ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤
```

### AddressSanitizer

–ü—Ä–æ–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å AddressSanitizer –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –ø–∞–º—è—Ç—å—é:

```bash
# ASan –≤–∫–ª—é—á–µ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
cmake .. -DUSE_ASAN=ON

# –î–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
cmake .. -DUSE_ASAN=OFF
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
ROS_TOPIC/
‚îú‚îÄ‚îÄ include/
‚îÇ   ‚îî‚îÄ‚îÄ arch/
‚îÇ       ‚îú‚îÄ‚îÄ concurrency/              # –ú–æ–¥—É–ª—å –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç–∏
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ impl/                  # –ë–∞–∑–æ–≤—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ queue_thread_pool.h/cpp  # Thread pool implementation
‚îÇ       ‚îú‚îÄ‚îÄ communication/             # –ú–æ–¥—É–ª—å –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ i_message.h            # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ waitable.h              # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å Waitable –¥–ª—è Executor
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ impl/                   # –ë–∞–∑–æ–≤—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ callback_group.h    # –ì—Ä—É–ø–ø—ã –∫–æ–ª–±—ç–∫–æ–≤
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ executor.h          # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ factory.h           # Factory –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ç–æ—Ä–æ–≤/–ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ (ROS2-like)
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ publisher.h         # –ü—É–±–ª–∏–∫–∞—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ qos.h               # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ QoS
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ subscriber_slot.h   # –°–ª–æ—Ç –ø–æ–¥–ø–∏—Å—á–∏–∫–∞ —Å lock-free –æ—á–µ—Ä–µ–¥—å—é
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ subscription.h      # Subscription –∫–ª–∞—Å—Å (ROS2-like)
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ topic.h             # –¢–æ–ø–∏–∫ –¥–ª—è –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ wait_set.h          # –ú–µ—Ö–∞–Ω–∏–∑–º –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
‚îÇ       ‚îî‚îÄ‚îÄ experimental/               # –ú–æ–¥—É–ª—å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
‚îÇ           ‚îî‚îÄ‚îÄ benchmark.h             # –°–∏—Å—Ç–µ–º–∞ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤
‚îú‚îÄ‚îÄ examples/
‚îÇ   ‚îî‚îÄ‚îÄ ros2_like_example.cpp          # –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ROS2-like API
‚îú‚îÄ‚îÄ main.cpp                            # –ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ –±–µ–Ω—á–º–∞—Ä–∫–∞–º–∏
‚îî‚îÄ‚îÄ CMakeLists.txt                      # –§–∞–π–ª —Å–±–æ—Ä–∫–∏ CMake
‚îî‚îÄ‚îÄ README.md                # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## üî¨ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Lock-free –æ—á–µ—Ä–µ–¥–∏

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ lock-free –æ—á–µ—Ä–µ–¥–µ–π:

1. **`LockFreeMPMCQueue`**: Multi-Producer Multi-Consumer –æ—á–µ—Ä–µ–¥—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ Vyukov
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç CAS (Compare-And-Swap) –æ–ø–µ—Ä–∞—Ü–∏–∏
   - –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø—Ä–æ–¥—é—Å–µ—Ä–æ–≤ –∏ –∫–æ–Ω—Å—å—é–º–µ—Ä–æ–≤
   - Cache-line aligned –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è false sharing

2. **`LockFreeSPSCQueue`**: Single-Producer Single-Consumer –æ—á–µ—Ä–µ–¥—å
   - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è —Å–ª—É—á–∞—è –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–¥—é—Å–µ—Ä–∞ –∏ –æ–¥–Ω–æ–≥–æ –∫–æ–Ω—Å—å—é–º–µ—Ä–∞
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç relaxed memory ordering –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   - –ë—ã—Å—Ç—Ä–µ–µ MPMC –¥–ª—è SPSC —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

### Epoch-based Memory Reclamation

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è epoch-based reclaimer –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –≤ lock-free —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—è use-after-free –æ—à–∏–±–∫–∏.

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

–°–∏—Å—Ç–µ–º–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è –≤—ã—Å–æ–∫–æ–π –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏:

- **SPSC**: –î–æ 800K+ —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫
- **MPSC**: –î–æ 250K+ —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫ (4 –ø—Ä–æ–¥—é—Å–µ—Ä–∞)
- **Latency**: –°—Ä–µ–¥–Ω—è—è –∑–∞–¥–µ—Ä–∂–∫–∞ < 1 –º—Å

*–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–≥—É—Ç –≤–∞—Ä—å–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–ø–ø–∞—Ä–∞—Ç–Ω–æ–≥–æ –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∏ –Ω–∞–≥—Ä—É–∑–∫–∏.*

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –í–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞

–†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫–∏ –≤—ã–≤–æ–¥–∞ –≤ `Benchmark.h` –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:

```cpp
// –í Benchmark.h —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ:
std::cerr << "[SPSC] Sending..." << std::flush;
std::cerr << " Done\n";
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±–µ–Ω—á–º–∞—Ä–∫–æ–≤ –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —Ñ–∞–π–ª:

```cpp
Benchmark::save_results_to_csv(results, "detailed_results.csv");
```

## üìù –õ–∏—Ü–µ–Ω–∑–∏—è

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —è–≤–ª—è–µ—Ç—Å—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–º –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Ü–µ–ª–µ–π.

## ü§ù –í–∫–ª–∞–¥

–ü—Ä–æ–µ–∫—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é—Ç—Å—è!

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- –í—Å–µ –∫–ª–∞—Å—Å—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ namespace `arch::experimental`
- –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö (Doxygen)
- –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ `main.cpp` –∏ `examples/ros2_like_example.cpp`
- –î–ª—è –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è –∫ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ ROS2 —Å–º. `ROS2_IMPROVEMENTS.md`

## üÜï –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (ROS2-like API)

–°–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ROS2-–ø–æ–¥–æ–±–Ω—ã–π API:

- **Factory**: –§–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—É–±–ª–∏–∫–∞—Ç–æ—Ä–æ–≤ –∏ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
- **Subscription**: –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—É—â–Ω–æ—Å—Ç—å –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫ (–∫–∞–∫ –≤ ROS2)
- **Waitable**: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π
- **Entity**: –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º

–≠—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–¥ –±–æ–ª–µ–µ –ø–æ—Ö–æ–∂–∏–º –Ω–∞ ROS2 –∏ —É–ø—Ä–æ—â–∞–µ—Ç –º–∏–≥—Ä–∞—Ü–∏—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö ROS2 –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- –¢—Ä–µ–±—É–µ—Ç—Å—è C++17 (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –±–æ–ª–µ–µ —Å—Ç–∞—Ä—ã–º–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º–∏)
- –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç Qt Core (–¥–ª—è WaitSet)
- –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±–∞–≥–∏

---

**–í–µ—Ä—Å–∏—è**: 1.0.0  
**–î–∞—Ç–∞**: 2024  
**–ê–≤—Ç–æ—Ä**: ARCH Experimental Team


